}#end for how much PNs
##
}#end if ignore MBD within 24 hrs
}#end for
wait_till_textappear
##Open newly added weeklyPN, write content and click save
#open newly added note for edit
##wait
data$remDr$refresh()
wait_till_steadystate(data,"/html/body", steadythres = 5) #wait
#doTillSuccess({
##
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
newProgNote <- (grepl("請輸入標題", tolower(NoteList)) & grepl("暫存", tolower(NoteList)) &
(difftime(Sys.Date(),as.Date(sapply(NoteList,str_extract,"\\d\\d\\d\\d/\\d\\d?/\\d\\d?")),units = "days") == 0))  #bug for future notes
newNoteIndex <- (c(1:length(newProgNote))[newProgNote]-1)[1] #in case of multiple indicies, use the first one
##
##
webElem1 <- data$remDr$findElement(using = "id",
value = paste("NTUHWeb1_ucProgressNoteList_grvSOList_ctrl",
newNoteIndex,"_NoteName",sep=""))
webElem1$clickElement()
#wait till note edit opened
wait_till_IDloaded(data,"NTUHWeb1_BlankNoteMainTab_txbBlankContnt")
wait_till_ClassDisappear(data,"loadmask")
#},data) #end till success
webElem1 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_ucInsertDateTime_YearInput")
webElem2 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_ucInsertDateTime_MonthInput")
webElem3 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_ucInsertDateTime_DayInput")
webElem4 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_ucInsertDateTime_HourInput")
webElem5 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_ucInsertDateTime_MinuteInput")
webElem1$clearElement()
webElem2$clearElement()
webElem3$clearElement()
webElem4$clearElement()
webElem5$clearElement()
#webElem1$sendKeysToElement(list(format(Sys.time(), "%Y")))
#webElem2$sendKeysToElement(list(format(Sys.time(), "%m")))
#webElem3$sendKeysToElement(list(toString(as.numeric(format(Sys.time(), "%d"))+PN.index))) #PN.index 1..2 next& nextnext day
##bug 2015-10-30, the date needs to be added by date, not numeric or else will happen 10/31 -> 10/32 ...error
output.date <- Sys.Date() + PN.index
webElem1$sendKeysToElement(list(format(output.date, "%Y")))
webElem2$sendKeysToElement(list(format(output.date, "%m")))
webElem3$sendKeysToElement(list(format(output.date, "%d")))
#
webElem4$sendKeysToElement(list("7"))
webElem5$sendKeysToElement(list("0"))
#
webElem6 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_txbBlankTitle")
webElem8 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_txbVSEmpNo")
webElem6$sendKeysToElement(list("Progress Note"))
webElem8$clearElement()
webElem8$sendKeysToElement(list(DutyVS))
#webElem8$sendKeysToElement(list(DutyVS[PN.index]))
#for content
script <- 'document.getElementById("NTUHWeb1_BlankNoteMainTab_txbBlankContnt").value = arguments[0];'
#trash <- data$remDr$executeScript(script, args = list(paste("Problem:\n",
#                                                            WeeklyDiagnosis,"\n\n",
#                                                            "Assessment:\n",
#                                                            AssessDATA1,"\n",AssessDATA2,"\n\n",
#                                                            "\nPlan:\n",
#                                                            "1. Keep current rehabilitation programs\n",
#                                                            "2. Monitor clinical status, control risk factors",
#                                                            sep="")))[[1]]
while(T){
message("waiting for JS to execute...")
##
script2 <- 'return document.getElementById("NTUHWeb1_BlankNoteMainTab_txbBlankContnt").value'
result <- data$remDr$executeScript(script2, args = list())[[1]]
if (nchar(result)>10){break}
Sys.sleep(1)
##
script <- 'document.getElementById("NTUHWeb1_BlankNoteMainTab_txbBlankContnt").value = arguments[0];
document.getElementById("NTUHWeb1_BlankNoteMainTab_txbBlankTitle").value = arguments[1];'
trash <- data$remDr$executeScript(script, args = list(paste("Problem:\n",
WeeklyDiagnosis,"\n\n",
#"Assessment:\n",
#AssessDATA1,"\n",AssessDATA2,"\n\n",
"Vital signs:\n",
"\nPlan:\n",
"1. Keep current rehabilitation programs\n",
"2. Monitor clinical status, control risk factors",
sep=""),
"Progress Note"))[[1]]
}#end while
#save
webElem9 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_btnSaveBlankNote")
webElem9$clickElement()
##module do weekly note for modification
## does weekly note x1 + progress notes x2
##utilizes the reuslts from crawler.R
#version 2015/12/4
setwd("/Users/peishenwu/Google 雲端硬碟/【01】醫學/PMR/R_portal/R_portal_Sys_v1.0/")
source("CommonLib.R")
source("GetUpdates.R")
#
DutyVS <- EnterBox("Enter duty VS ID:")
PNnoteNum <- EnterBox(" How many days of notes?")
#DutyVS <- c("000908","000908","000908","004554")
#
patientDB <- readRDS("patient_status_DB.rds")
print(paste("patientDB captured at time:",patientDB$captureTime,sep=" ")) #show DB time
patientCount <- length(patientDB$table$name)
#prepare browser
logindata<-portal_login(c(readRDS("defaultUser.rds")))
#print patient list
#patientDB$table[,1:7]
#
#  i= 1
#
for (i in 1:patientCount){
#for (i in c(6)){
#for (i in c(1)){
##print progress
print(paste("Currently working on patient: ",
patientDB$table$ward[i],"-",patientDB$table$room[i],"-",patientDB$table$bed[i]," ",
patientDB$table$name[i]," (",i,"/",patientCount,")",
sep=""))
#ignore those who are MBD today (choose those who's dischargeDate is Inf) ##bug on 2015/4/24
if (dateDiff(patientDB$table$dischargeStatus[i],"%Y/%m/%d") >1){
doTillSuccess({
#navigate to patient by chartNo
navigatePatient(logindata, patientDB$table$chartNo[i])
#wait and get info
wait_till_element(logindata$remDr, "NTUHWeb1_QueryInPatientPersonAccountControl1_DataGridAccountList")
##
data <-  getWardList(logindata$remDr)
},data)
#navigate to progress note
#the one within the same admission date
PNlink <- data$pList[as.character(data$pList$NTUHadmission) == as.character(patientDB$table$NTUHadmission[i]),]$ProgNote
data$remDr$navigate(PNlink)
#wait till loaded
wait_till_element(data$remDr, "NTUHWeb1_ProblemQueryByAccList1_btnDisplayInValidProblem",
retry_thres = 20,
expr = {
data$remDr$navigate(PNlink)
})
#click add new weekly note
clickElement(data,"NTUHWeb1_btnInsertWeeklySummaryNote")
wait_till_steadystate(data,"/html/body", steadythres = 5)
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
while (T){
#
if (length(NoteList)!=0){
newProgNote <- (grepl("weekly", tolower(NoteList)) & grepl("暫存", tolower(NoteList)) &
(difftime(Sys.Date(),as.Date(sapply(NoteList,str_extract,"\\d\\d\\d\\d/\\d\\d?/\\d\\d?")),units = "days") == 0))  #bug for future notes
#to do the new added, must >0
if (sum(newProgNote)!=0) #if any is true
{ break } #break if complete - where there is "progress", "暫存" at today's date
}#end if
#
Sys.sleep(1)
data$remDr$refresh()
wait_till_steadystate(data,"/html/body", steadythres = 5) #wait
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
}#end while
#determine the index of the newly added note - not always 0
newNoteIndex <- (c(1:length(newProgNote))[newProgNote]-1)[1] #in case of multiple indicies, use the first one
#open newly added note for edit
source("OpenNewAddWeeklyNote.R")
#insert two PAPs
script <- "InsertPAPTab('Weekly');InsertPAPTab('Weekly');"
result <- data$remDr$executeScript(script, args = list())[[1]]
#wait
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1")
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2")
##
source("genWeeklyNote_content.R")
#Write content
script <- 'document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1").value = arguments[0];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment1").value = arguments[1];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan1").value = arguments[2];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2").value = arguments[3];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment2").value = arguments[4];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan2").value = arguments[5];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbBriefSummary").value = arguments[6];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbDiagnosis").value = arguments[7];'
trash <- data$remDr$executeScript(script, args = list(ProbDATA1,
AssessDATA1,
PlanDATA1,
ProbDATA2,
paste(VitalDATA,"\n",AssessDATA2,sep=""),
PlanDATA2,
WeeklySumTXT,
WeeklyDiagnosis))[[1]]
#save
#unknown bug that results in freezing sometimes....
doTillSuccess({
webElem7 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_WeeklySummaryMainTab_btnSaveWeeklySummary")
webElem7$clickElement()
},data)
#wait till complete
wait_till_textappear(data, "NTUHWeb1_WeeklySummaryMainTab_lblShowMessage", "暫存成功",
15,{
data$remDr$navigate(PNlink)
data$remDr$refresh()
source("OpenNewAddWeeklyNote.R")
#wait
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1")
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2")
#Write content
script <- 'document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1").value = arguments[0];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment1").value = arguments[1];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan1").value = arguments[2];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2").value = arguments[3];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment2").value = arguments[4];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan2").value = arguments[5];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbBriefSummary").value = arguments[6];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbDiagnosis").value = arguments[7];'
trash <- data$remDr$executeScript(script, args = list(ProbDATA1,
AssessDATA1,
PlanDATA1,
ProbDATA2,
paste(VitalDATA,"\n",AssessDATA2,sep=""),
PlanDATA2,
WeeklySumTXT,
WeeklyDiagnosis))[[1]]
##
webElem7 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_WeeklySummaryMainTab_btnSaveWeeklySummary")
webElem7$clickElement()
})
#wait_till_ClassLoaded(data,"blockUI blockMsg blockPage")
#wait_till_ClassLoaded(data,"growlUI")
#wait_till_ClassDisappear(data,"growlUI")
##########################################
## add two free notes as progress notes ##
##########################################
for (PN.index in 1:as.numeric(PNnoteNum)){ #notes number determined by user - PNnoteNum
#for (PN.index in 1:4){ #four notes
#refresh
#Sys.sleep(1)
data$remDr$refresh()
data$remDr$navigate(PNlink)
wait_till_element(data$remDr, "NTUHWeb1_ProblemQueryByAccList1_btnDisplayInValidProblem")
#click add new progress note
Sys.sleep(1)
clickElement(data,"NTUHWeb1_btnInsertBlankNote")
Sys.sleep(1)
wait_till_steadystate(data,"/html/body", steadythres = 5)
#wait_till_IDloaded(data,"Layer1")
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
while (T){
if (length(NoteList)!=0){
newProgNote <- (grepl("請輸入標題", tolower(NoteList)) & grepl("暫存", tolower(NoteList)) &
(difftime(Sys.Date(),as.Date(sapply(NoteList,str_extract,"\\d\\d\\d\\d/\\d\\d?/\\d\\d?")),units = "days") == 0))  #bug for future notes
#to do the new added, must >0
if (sum(newProgNote)!=0) #if any is true
{ break } #break if complete - where there is "請輸入標題", "暫存" at today's date
}#end if
#
#Sys.sleep(2)
#
data$remDr$refresh()
wait_till_steadystate(data,"/html/body", steadythres = 5) #wait
##reload the page
data$remDr$navigate(PNlink)
wait_till_element(data$remDr, "NTUHWeb1_ProblemQueryByAccList1_btnDisplayInValidProblem")
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
}#end while
##Open newly added weeklyPN, write content and click save
source("open_writeNewWeekPN.R")
#wait till complete
wait_till_textappear(data,
"NTUHWeb1_BlankNoteMainTab_lblShowMessage",
"暫存成功",
15, {
#webElem9 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_btnSaveBlankNote")
#webElem9$clickElement()
data$remDr$navigate(PNlink)
source("open_writeNewWeekPN.R")
})
#wait_till_ClassLoaded(data,"growlUI")
#wait_till_ClassDisappear(data,"growlUI")
}#end for how much PNs
##
}#end if ignore MBD within 24 hrs
}#end for
##module do weekly note for modification
## does weekly note x1 + progress notes x2
##utilizes the reuslts from crawler.R
#version 2015/12/4
setwd("/Users/peishenwu/Google 雲端硬碟/【01】醫學/PMR/R_portal/R_portal_Sys_v1.0/")
source("CommonLib.R")
source("GetUpdates.R")
#
DutyVS <- EnterBox("Enter duty VS ID:")
PNnoteNum <- EnterBox(" How many days of notes?")
#DutyVS <- c("000908","000908","000908","004554")
#
patientDB <- readRDS("patient_status_DB.rds")
print(paste("patientDB captured at time:",patientDB$captureTime,sep=" ")) #show DB time
patientCount <- length(patientDB$table$name)
#prepare browser
logindata<-portal_login(c(readRDS("defaultUser.rds")))
#print patient list
#patientDB$table[,1:7]
#
#  i= 1
#
for (i in 1:patientCount){
#for (i in c(6)){
#for (i in c(1)){
##print progress
print(paste("Currently working on patient: ",
patientDB$table$ward[i],"-",patientDB$table$room[i],"-",patientDB$table$bed[i]," ",
patientDB$table$name[i]," (",i,"/",patientCount,")",
sep=""))
#ignore those who are MBD today (choose those who's dischargeDate is Inf) ##bug on 2015/4/24
if (dateDiff(patientDB$table$dischargeStatus[i],"%Y/%m/%d") >1){
doTillSuccess({
#navigate to patient by chartNo
navigatePatient(logindata, patientDB$table$chartNo[i])
#wait and get info
wait_till_element(logindata$remDr, "NTUHWeb1_QueryInPatientPersonAccountControl1_DataGridAccountList")
##
data <-  getWardList(logindata$remDr)
},data)
#navigate to progress note
#the one within the same admission date
PNlink <- data$pList[as.character(data$pList$NTUHadmission) == as.character(patientDB$table$NTUHadmission[i]),]$ProgNote
data$remDr$navigate(PNlink)
#wait till loaded
wait_till_element(data$remDr, "NTUHWeb1_ProblemQueryByAccList1_btnDisplayInValidProblem",
retry_thres = 20,
expr = {
data$remDr$navigate(PNlink)
})
#click add new weekly note
clickElement(data,"NTUHWeb1_btnInsertWeeklySummaryNote")
wait_till_steadystate(data,"/html/body", steadythres = 5)
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
while (T){
#
if (length(NoteList)!=0){
newProgNote <- (grepl("weekly", tolower(NoteList)) & grepl("暫存", tolower(NoteList)) &
(difftime(Sys.Date(),as.Date(sapply(NoteList,str_extract,"\\d\\d\\d\\d/\\d\\d?/\\d\\d?")),units = "days") == 0))  #bug for future notes
#to do the new added, must >0
if (sum(newProgNote)!=0) #if any is true
{ break } #break if complete - where there is "progress", "暫存" at today's date
}#end if
#
Sys.sleep(1)
data$remDr$refresh()
wait_till_steadystate(data,"/html/body", steadythres = 5) #wait
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
}#end while
#determine the index of the newly added note - not always 0
newNoteIndex <- (c(1:length(newProgNote))[newProgNote]-1)[1] #in case of multiple indicies, use the first one
#open newly added note for edit
source("OpenNewAddWeeklyNote.R")
#insert two PAPs
script <- "InsertPAPTab('Weekly');InsertPAPTab('Weekly');"
result <- data$remDr$executeScript(script, args = list())[[1]]
#wait
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1")
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2")
##
source("genWeeklyNote_content.R")
#Write content
script <- 'document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1").value = arguments[0];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment1").value = arguments[1];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan1").value = arguments[2];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2").value = arguments[3];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment2").value = arguments[4];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan2").value = arguments[5];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbBriefSummary").value = arguments[6];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbDiagnosis").value = arguments[7];'
trash <- data$remDr$executeScript(script, args = list(ProbDATA1,
AssessDATA1,
PlanDATA1,
ProbDATA2,
paste(VitalDATA,"\n",AssessDATA2,sep=""),
PlanDATA2,
WeeklySumTXT,
WeeklyDiagnosis))[[1]]
#save
#unknown bug that results in freezing sometimes....
doTillSuccess({
webElem7 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_WeeklySummaryMainTab_btnSaveWeeklySummary")
webElem7$clickElement()
},data)
#wait till complete
wait_till_textappear(data, "NTUHWeb1_WeeklySummaryMainTab_lblShowMessage", "暫存成功",
15,{
data$remDr$navigate(PNlink)
data$remDr$refresh()
source("OpenNewAddWeeklyNote.R")
#wait
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1")
wait_till_IDloaded(data,"NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2")
#Write content
script <- 'document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem1").value = arguments[0];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment1").value = arguments[1];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan1").value = arguments[2];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbProblem2").value = arguments[3];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbAssessment2").value = arguments[4];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_ucPAP_txbPlan2").value = arguments[5];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbBriefSummary").value = arguments[6];
document.getElementById("NTUHWeb1_WeeklySummaryMainTab_txbDiagnosis").value = arguments[7];'
trash <- data$remDr$executeScript(script, args = list(ProbDATA1,
AssessDATA1,
PlanDATA1,
ProbDATA2,
paste(VitalDATA,"\n",AssessDATA2,sep=""),
PlanDATA2,
WeeklySumTXT,
WeeklyDiagnosis))[[1]]
##
Sys.sleep(3)
##
webElem7 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_WeeklySummaryMainTab_btnSaveWeeklySummary")
webElem7$clickElement()
})
#wait_till_ClassLoaded(data,"blockUI blockMsg blockPage")
#wait_till_ClassLoaded(data,"growlUI")
#wait_till_ClassDisappear(data,"growlUI")
##########################################
## add two free notes as progress notes ##
##########################################
for (PN.index in 1:as.numeric(PNnoteNum)){ #notes number determined by user - PNnoteNum
#for (PN.index in 1:4){ #four notes
#refresh
#Sys.sleep(1)
data$remDr$refresh()
data$remDr$navigate(PNlink)
wait_till_element(data$remDr, "NTUHWeb1_ProblemQueryByAccList1_btnDisplayInValidProblem")
#click add new progress note
Sys.sleep(1)
clickElement(data,"NTUHWeb1_btnInsertBlankNote")
Sys.sleep(1)
wait_till_steadystate(data,"/html/body", steadythres = 5)
#wait_till_IDloaded(data,"Layer1")
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
while (T){
if (length(NoteList)!=0){
newProgNote <- (grepl("請輸入標題", tolower(NoteList)) & grepl("暫存", tolower(NoteList)) &
(difftime(Sys.Date(),as.Date(sapply(NoteList,str_extract,"\\d\\d\\d\\d/\\d\\d?/\\d\\d?")),units = "days") == 0))  #bug for future notes
#to do the new added, must >0
if (sum(newProgNote)!=0) #if any is true
{ break } #break if complete - where there is "請輸入標題", "暫存" at today's date
}#end if
#
#Sys.sleep(2)
#
data$remDr$refresh()
wait_till_steadystate(data,"/html/body", steadythres = 5) #wait
##reload the page
data$remDr$navigate(PNlink)
wait_till_element(data$remDr, "NTUHWeb1_ProblemQueryByAccList1_btnDisplayInValidProblem")
#
rootNode<-reloadHTML(data)
NoteList<-xpathSApply(rootNode,
'//*[@id="tblNoteList"]/tbody/tr/td[@class="helpBod helpTimeField pointerCursor"]',
xmlGetAttr, name = "title")
}#end while
##Open newly added weeklyPN, write content and click save
source("open_writeNewWeekPN.R")
#wait till complete
wait_till_textappear(data,
"NTUHWeb1_BlankNoteMainTab_lblShowMessage",
"暫存成功",
15, {
#webElem9 <- data$remDr$findElement(using = "id", value = "NTUHWeb1_BlankNoteMainTab_btnSaveBlankNote")
#webElem9$clickElement()
data$remDr$refresh()
data$remDr$navigate(PNlink)
source("open_writeNewWeekPN.R")
})
#wait_till_ClassLoaded(data,"growlUI")
#wait_till_ClassDisappear(data,"growlUI")
}#end for how much PNs
##
}#end if ignore MBD within 24 hrs
}#end for
16000 %% 2
16000 %/% 2
16000 %/% 0
setwd("/Users/peishenwu/Google 雲端硬碟/【01】醫學/PMR/R2/排班/Planner")  ##modify the path here...
msg <- try({source("planner.R")},F)[1]
msg <- try({source("planner.R")},F)[1]
